<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkFlow - Assignment Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #b66dff;
            --primary-dark: #9946e6;
            --secondary: #00d25b;
            --warning: #ffab00;
            --danger: #fc424a;
            --info: #00d0ff;
            --dark: #191c24;
            --darker: #0f1015;
            --card-bg: #1f2128;
            --border-color: #2c2e33;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --text-muted: #6c757d;
        }

        /* Light Theme */
        body.light-theme {
            --dark: #f5f7fa;
            --darker: #ffffff;
            --card-bg: #ffffff;
            --border-color: #e0e6ed;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --text-muted: #9ca3af;
        }

        /* Midnight Theme */
        body.midnight-theme {
            --dark: #0a0e27;
            --darker: #050816;
            --card-bg: #0f1729;
            --border-color: #1a1f3a;
            --primary: #a78bfa;
            --secondary: #34d399;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            background: var(--dark);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 255px;
            height: 100vh;
            background: var(--darker);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s;
        }

        .sidebar-brand {
            padding: 1.5rem 1.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-brand-icon {
            font-size: 2rem;
        }

        .sidebar-brand-text {
            font-size: 1.5rem;
            font-weight: 700;
            -webkit-background-clip: text;
            color: #ffab00;
            background-clip: text;
        }

        .sidebar-menu {
            padding: 1.5rem 0;
        }

        .sidebar-menu-item {
            padding: 0.75rem 1.875rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .sidebar-menu-item:hover {
            color: var(--text-primary);
            background: rgba(182, 109, 255, 0.1);
        }

        .sidebar-menu-item.active {
            color: var(--text-primary);
            background: rgba(182, 109, 255, 0.1);
            border-left-color: var(--primary);
        }

        .sidebar-menu-icon {
            font-size: 1.2rem;
            width: 20px;
        }

        /* Main Content */
        .main-panel {
            margin-left: 255px;
            min-height: 100vh;
            background: var(--dark);
            transition: all 0.3s;
        }

        /* Navbar */
        .navbar {
            background: var(--card-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .navbar-left h4 {
            font-weight: 500;
            color: var(--text-primary);
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .user-profile:hover {
            background: rgba(182, 109, 255, 0.1);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge {
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Content Area */
        .content-wrapper {
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h3 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .breadcrumb {
            display: flex;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(182, 109, 255, 0.15);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .stat-card.primary .stat-icon {
            background: rgba(182, 109, 255, 0.2);
            color: var(--primary);
        }

        .stat-card.success .stat-icon {
            background: rgba(0, 210, 91, 0.2);
            color: var(--secondary);
        }

        .stat-card.warning .stat-icon {
            background: rgba(255, 171, 0, 0.2);
            color: var(--warning);
        }

        .stat-card.danger .stat-icon {
            background: rgba(252, 66, 74, 0.2);
            color: var(--danger);
        }

        /* Assignment Cards */
        .assignments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .assignment-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .assignment-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(182, 109, 255, 0.2);
        }

        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .assignment-badge {
            background: rgba(182, 109, 255, 0.2);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .assignment-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .assignment-course {
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .assignment-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .assignment-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .assignment-status.pending {
            background: rgba(255, 171, 0, 0.2);
            color: var(--warning);
        }

        .assignment-status.late {
            background: rgba(252, 66, 74, 0.2);
            color: var(--danger);
        }

        /* Login Page */
        .auth-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--dark);
            padding: 2rem;
        }

        .auth-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .auth-card h2 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .btn-google {
            background: white;
            color: #333;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e63946;
        }

        .mode-indicator {
            margin-top: 1.5rem;
            padding: 0.75rem;
            background: rgba(255, 171, 0, 0.1);
            border-radius: 8px;
            color: var(--warning);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(252, 66, 74, 0.1);
            color: var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid var(--danger);
        }

        /* Responsive */
        @media (max-width: 991px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-panel {
                margin-left: 0;
            }

            .assignments-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="auth-page" id="loginPage">
        <div class="auth-card">
            <div class="sidebar-brand-icon">üìä</div>
            <h2>WorkFlow</h2>
            <p>Track all your Google Classroom assignments in one beautiful dashboard</p>
            
            <button class="btn btn-google" id="googleLoginBtn">
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <path fill="#4285f4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
                    <path fill="#34a853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
                    <path fill="#fbbc05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
                    <path fill="#ea4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
                </svg>
                Sign in with Google Classroom
            </button>
            
            <div class="mode-indicator" id="modeIndicator">üé≠ Mock Data Mode - No API calls required</div>
            <div id="errorMsg" class="error" style="display: none;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-brand">
                <span class="sidebar-brand-icon">üìä</span>
                <span class="sidebar-brand-text">WorkFlow</span>
            </div>
            <div class="sidebar-menu">
                <a class="sidebar-menu-item active" onclick="showPage('assignments')">
                    <span class="sidebar-menu-icon">üìù</span>
                    <span>Assignments</span>
                </a>
                <a class="sidebar-menu-item" onclick="showPage('statistics')">
                    <span class="sidebar-menu-icon">üìä</span>
                    <span>Statistics</span>
                </a>
                <a class="sidebar-menu-item" onclick="showPage('courses')">
                    <span class="sidebar-menu-icon">üìö</span>
                    <span>Courses</span>
                </a>
                <a class="sidebar-menu-item" onclick="showPage('settings')">
                    <span class="sidebar-menu-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Navbar -->
            <div class="navbar">
                <div class="navbar-left">
                    <h4>Dashboard</h4>
                </div>
                <div class="navbar-right">
                    <div class="user-profile">
                        <div class="user-avatar"></div>
                        <div>
                            <div class="user-name"></div>
                            <div class="badge">Connected</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" id="logoutBtn" style="padding: 0.5rem 1rem;">Logout</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content-wrapper">
                <!-- Assignments Page -->
                <div id="assignmentsPage">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h3>My Assignments</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Assignments</span>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card primary">
                            <div class="stat-info">
                                <h3 id="totalCount">0</h3>
                                <div class="stat-label">Total Assignments</div>
                            </div>
                            <div class="stat-icon">üìö</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-info">
                                <h3 id="pendingCount">0</h3>
                                <div class="stat-label">Pending</div>
                            </div>
                            <div class="stat-icon">‚è≥</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-info">
                                <h3 id="lateCount">0</h3>
                                <div class="stat-label">Late</div>
                            </div>
                            <div class="stat-icon">‚ö†Ô∏è</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-info">
                                <h3 id="dueToday">0</h3>
                                <div class="stat-label">Due Today</div>
                            </div>
                            <div class="stat-icon">üéØ</div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingMsg" class="loading" style="display: none;">
                        Loading your assignments...
                    </div>

                    <!-- Assignments Grid -->
                    <div class="assignments-grid" id="assignmentsList"></div>
                </div>

                <!-- Statistics Page -->
                <div id="statisticsPage" style="display: none;">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h3>Statistics & Analytics</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Statistics</span>
                        </div>
                    </div>

                    <!-- Stats Overview -->
                    <div class="stats-grid">
                        <div class="stat-card warning">
                            <div class="stat-info">
                                <h3 id="upcomingWeek">0</h3>
                                <div class="stat-label">Due This Week</div>
                            </div>
                            <div class="stat-icon">üìÖ</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-info">
                                <h3 id="overdueTotal">0</h3>
                                <div class="stat-label">Total Overdue</div>
                            </div>
                            <div class="stat-icon">üö®</div>
                        </div>
                        <div class="stat-card primary">
                            <div class="stat-info">
                                <h3 id="totalCourses">0</h3>
                                <div class="stat-label">Active Courses</div>
                            </div>
                            <div class="stat-icon">üìö</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-info">
                                <h3 id="avgPerCourse">0</h3>
                                <div class="stat-label">Avg per Course</div>
                            </div>
                            <div class="stat-icon">üìä</div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <!-- Status Distribution -->
                        <div class="card">
                            <div class="card-title">Assignment Status Distribution</div>
                            <canvas id="statusChart" style="max-height: 300px;"></canvas>
                        </div>

                        <!-- Course Breakdown -->
                        <div class="card">
                            <div class="card-title">Assignments by Course</div>
                            <canvas id="courseChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- Upcoming Deadlines -->
                    <div class="card">
                        <div class="card-title">üìÖ Upcoming Deadlines (Next 7 Days)</div>
                        <div id="upcomingDeadlines" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <!-- Courses Page -->
                <div id="coursesPage" style="display: none;">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h3>My Courses</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Courses</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">üìö Manage Your Courses</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Uncheck courses you want to ignore. They won't appear in assignments or statistics.</p>
                        <div id="coursesList"></div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" style="display: none;">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h3>Settings</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Settings</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">üé® Appearance</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Choose your preferred theme</p>
                        
                        <div style="display: grid; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" class="theme-option" data-theme="dark">
                                <input type="radio" name="theme" value="dark" style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">üåô Dark Mode</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Default dark theme with purple accents</div>
                                </div>
                            </label>

                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" class="theme-option" data-theme="midnight">
                                <input type="radio" name="theme" value="midnight" style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">üåå Midnight Mode</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Deeper blacks for OLED screens</div>
                                </div>
                            </label>

                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" class="theme-option" data-theme="light">
                                <input type="radio" name="theme" value="light" style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">‚òÄÔ∏è Light Mode</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Bright theme for daytime use</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google API -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
        // Configuration
        const USE_MOCK_DATA = false;
        const GOOGLE_CLIENT_ID = '204169741443-lrnat59d7ob8ae63srsbg2ojefn1f51h.apps.googleusercontent.com';
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.coursework.students.readonly https://www.googleapis.com/auth/classroom.student-submissions.students.readonly';

        let googleTokenClient;
        let googleAccessToken = null;
        let allAssignmentsData = [];
        let statusChartInstance = null;
        let courseChartInstance = null;
        let allCoursesData = [];
        let ignoredCourses = new Set(JSON.parse(localStorage.getItem('ignoredCourses') || '[]'));
        let currentTheme = localStorage.getItem('theme') || 'dark';

        // Mock Data
        const MOCK_GOOGLE_ASSIGNMENTS = [
            {
                source: 'google',
                title: 'Math Homework - Chapter 5: Quadratic Equations',
                courseName: 'Advanced Mathematics',
                dueDate: { year: 2025, month: 11, day: 15 },
                dueTime: { hours: 23, minutes: 59 },
                status: 'pending',
                link: '#'
            },
            {
                source: 'google',
                title: 'Essay: Impact of Climate Change',
                courseName: 'Environmental Science',
                dueDate: { year: 2025, month: 11, day: 14 },
                dueTime: { hours: 23, minutes: 59 },
                status: 'late',
                link: '#'
            },
            {
                source: 'google',
                title: 'Reading Quiz - Chapters 10-12',
                courseName: 'English Literature',
                dueDate: { year: 2025, month: 11, day: 20 },
                dueTime: { hours: 14, minutes: 0 },
                status: 'pending',
                link: '#'
            },
            {
                source: 'google',
                title: 'Science Lab Report: Photosynthesis',
                courseName: 'Biology',
                dueDate: { year: 2025, month: 11, day: 22 },
                dueTime: { hours: 23, minutes: 59 },
                status: 'pending',
                link: '#'
            },
            {
                source: 'google',
                title: 'History Project: Ancient Civilizations',
                courseName: 'World History',
                dueDate: { year: 2025, month: 11, day: 25 },
                dueTime: { hours: 23, minutes: 59 },
                status: 'pending',
                link: '#'
            },
            {
                source: 'google',
                title: 'Physics Problem Set #7',
                courseName: 'Physics',
                dueDate: { year: 2025, month: 11, day: 15 },
                dueTime: { hours: 23, minutes: 59 },
                status: 'pending',
                link: '#'
            }
        ];

        // Initialize Google Auth
        function initializeGoogleAuth() {
            if (USE_MOCK_DATA) {
                console.log('üìã Mock mode enabled');
                return;
            }

            googleTokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: handleGoogleAuthResponse,
            });
        }

        function handleGoogleAuthResponse(response) {
            if (response.error) {
                showError('Google authentication failed: ' + response.error);
                return;
            }
            
            googleAccessToken = response.access_token;
            showDashboard();
            loadAssignments();
        }

        // Load Assignments
        async function loadAssignments() {
            const loadingMsg = document.getElementById('loadingMsg');
            const assignmentsList = document.getElementById('assignmentsList');
            
            loadingMsg.style.display = 'block';
            assignmentsList.innerHTML = '';

            if (USE_MOCK_DATA) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                allAssignmentsData = MOCK_GOOGLE_ASSIGNMENTS;
                displayAssignments(allAssignmentsData);
                updateStats(allAssignmentsData);
                loadingMsg.style.display = 'none';
                return;
            }

            try {
                const userinfo = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
                headers: { Authorization: `Bearer ${googleAccessToken}` }
                });
                const pfp = await userinfo.json();
                const avatarDiv = document.querySelector('.user-avatar');

                avatarDiv.style.backgroundImage = `url(${pfp.picture})`;

                avatarDiv.style.backgroundSize = "cover";  // Ensures the image covers the entire div
                avatarDiv.style.backgroundPosition = "center"; // Centers the image within the div
                
                const nameDiv = document.querySelector('.user-name')
                nameDiv.textContent = pfp.name

                const coursesResponse = await fetch(
                    'https://classroom.googleapis.com/v1/courses?courseStates=ACTIVE',
                    { headers: { 'Authorization': `Bearer ${googleAccessToken}` }}
                );

                if (!coursesResponse.ok) throw new Error('Failed to fetch courses');

                const coursesData = await coursesResponse.json();
                const courses = coursesData.courses || [];
                
                // Store all courses for the Courses page
                allCoursesData = courses;
                
                const coursePromises = courses.map(async (course) => {
                    try {
                        const courseworkResponse = await fetch(
                            `https://classroom.googleapis.com/v1/courses/${course.id}/courseWork`,
                            { headers: { 'Authorization': `Bearer ${googleAccessToken}` }}
                        );

                        if (!courseworkResponse.ok) return [];

                        const courseworkData = await courseworkResponse.json();
                        const coursework = courseworkData.courseWork || [];

                        const assignmentPromises = coursework.map(async (work) => {
                            try {
                                const submissionResponse = await fetch(
                                    `https://classroom.googleapis.com/v1/courses/${course.id}/courseWork/${work.id}/studentSubmissions`,
                                    { headers: { 'Authorization': `Bearer ${googleAccessToken}` }}
                                );

                                let status = 'pending';
                                if (submissionResponse.ok) {
                                    const submissionData = await submissionResponse.json();
                                    const submission = submissionData.studentSubmissions?.[0];
                                    if (submission) {
                                        status = submission.state === 'TURNED_IN' || submission.state === 'RETURNED' 
                                            ? 'submitted' 
                                            : submission.late ? 'late' : 'pending';
                                    }
                                }

                                return {
                                    source: 'google',
                                    title: work.title,
                                    courseName: course.name,
                                    dueDate: work.dueDate,
                                    dueTime: work.dueTime,
                                    status: status,
                                    link: work.alternateLink
                                };
                            } catch (error) {
                                console.error(`Error loading submission:`, error);
                                return null;
                            }
                        });

                        const assignments = await Promise.all(assignmentPromises);
                        return assignments.filter(a => a !== null);
                    } catch (error) {
                        console.error(`Error loading coursework:`, error);
                        return [];
                    }
                });

                const allAssignments = await Promise.all(coursePromises);
                const flatAssignments = allAssignments.flat();
                allAssignmentsData = flatAssignments;
                displayAssignments(flatAssignments);
                updateStats(flatAssignments);
            } catch (error) {
                showError('Failed to load assignments: ' + error.message);
            } finally {
                loadingMsg.style.display = 'none';
            }
        }

        function updateModeIndicator() {
            const indicator = document.getElementById('modeIndicator');
            if (USE_MOCK_DATA) {
                indicator.textContent = 'üé≠ MOCK DATA MODE - No API calls';
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Update Stats
        function updateStats(assignments) {
            // Filter out ignored courses
            const filteredAssignments = assignments.filter(a => !ignoredCourses.has(a.courseName));
            
            const pending = filteredAssignments.filter(a => a.status !== 'submitted');
            const late = filteredAssignments.filter(a => a.status === 'late');
            const dueToday = pending.filter(a => {
                const date = parseGoogleDate(a.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return date && date.getTime() === today.getTime();
            });

            document.getElementById('totalCount').textContent = pending.length;
            document.getElementById('pendingCount').textContent = pending.filter(a => a.status === 'pending').length;
            document.getElementById('lateCount').textContent = late.length;
            document.getElementById('dueToday').textContent = dueToday.length;
        }

        // Display Assignments
        function displayAssignments(assignments) {
            const assignmentsList = document.getElementById('assignmentsList');
            
            // Filter out ignored courses
            const filteredAssignments = assignments.filter(a => !ignoredCourses.has(a.courseName));
            const pendingAssignments = filteredAssignments.filter(a => a.status !== 'submitted');
            
            if (pendingAssignments.length === 0) {
                assignmentsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <h3>All caught up!</h3>
                        <p>You have no pending assignments.</p>
                    </div>
                `;
                return;
            }

            pendingAssignments.sort((a, b) => {
                const dateA = parseGoogleDate(a.dueDate);
                const dateB = parseGoogleDate(b.dueDate);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            assignmentsList.innerHTML = pendingAssignments.map(assignment => {
                const dueDate = formatDueDate(assignment);
                const statusClass = assignment.status;
                const statusText = assignment.status === 'late' ? 'Late' : 'Pending';
                const statusIcon = assignment.status === 'late' ? '‚ö†Ô∏è' : '‚è≥';

                return `
                    <div class="assignment-card" onclick="window.open('${assignment.link}', '_blank')">
                        <div class="assignment-header">
                            <span class="assignment-badge">Google Classroom</span>
                        </div>
                        <div class="assignment-title">${assignment.title}</div>
                        <div class="assignment-course">${assignment.courseName}</div>
                        <div class="assignment-meta">
                            <span>üìÖ ${dueDate}</span>
                        </div>
                        <div class="assignment-status ${statusClass}">
                            ${statusIcon} ${statusText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function parseGoogleDate(dueDate) {
            if (!dueDate) return null;
            return new Date(dueDate.year, dueDate.month - 1, dueDate.day);
        }

        function formatDueDate(assignment) {
            if (!assignment.dueDate) return 'No due date';
            
            const date = parseGoogleDate(assignment.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = date - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Due Today';
            if (diffDays === 1) return 'Due Tomorrow';
            if (diffDays < 0) return `${Math.abs(diffDays)} days overdue`;
            if (diffDays < 7) return `Due in ${diffDays} days`;
            
            return `Due ${date.toLocaleDateString()}`;
        }

        // UI Functions
        function showPage(page) {
            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.sidebar-menu-item').classList.add('active');

            // Hide all pages
            document.getElementById('assignmentsPage').style.display = 'none';
            document.getElementById('statisticsPage').style.display = 'none';
            document.getElementById('coursesPage').style.display = 'none';
            document.getElementById('settingsPage').style.display = 'none';

            // Show selected page
            if (page === 'assignments') {
                document.getElementById('assignmentsPage').style.display = 'block';
            } else if (page === 'statistics') {
                document.getElementById('statisticsPage').style.display = 'block';
                generateStatistics();
            } else if (page === 'courses') {
                document.getElementById('coursesPage').style.display = 'block';
                displayCourses();
            } else if (page === 'settings') {
                document.getElementById('settingsPage').style.display = 'block';
                initializeSettings();
            }
        }

        function displayCourses() {
            const coursesList = document.getElementById('coursesList');
            
            if (allCoursesData.length === 0) {
                coursesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>No courses found</h3>
                        <p>Loading courses...</p>
                    </div>
                `;
                return;
            }

            // Count assignments per course
            const assignmentCounts = {};
            allAssignmentsData.forEach(a => {
                if (a.status !== 'submitted') {
                    assignmentCounts[a.courseName] = (assignmentCounts[a.courseName] || 0) + 1;
                }
            });

            coursesList.innerHTML = allCoursesData.map(course => {
                const isIgnored = ignoredCourses.has(course.name);
                const assignmentCount = assignmentCounts[course.name] || 0;
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid ${isIgnored ? 'var(--text-muted)' : 'var(--primary)'};">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${isIgnored ? '' : 'checked'} onchange="toggleCourse('${course.name.replace(/'/g, "\\'")}', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                            </label>
                            <div style="flex: 1; ${isIgnored ? 'opacity: 0.5;' : ''}">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${course.name}</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    ${assignmentCount} pending assignment${assignmentCount !== 1 ? 's' : ''}
                                </div>
                            </div>
                        </div>
                        ${isIgnored ? '<span style="color: var(--text-muted); font-size: 0.875rem; font-weight: 600;">IGNORED</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleCourse(courseName, isEnabled) {
            if (isEnabled) {
                ignoredCourses.delete(courseName);
            } else {
                ignoredCourses.add(courseName);
            }
            
            // Save to localStorage
            localStorage.setItem('ignoredCourses', JSON.stringify([...ignoredCourses]));
            
            // Refresh displays
            displayAssignments(allAssignmentsData);
            updateStats(allAssignmentsData);
            displayCourses();
        }

        function initializeSettings() {
            // Set the current theme radio button
            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                if (radio.value === currentTheme) {
                    radio.checked = true;
                    radio.closest('.theme-option').style.borderColor = 'var(--primary)';
                }
            });

            // Add event listeners
            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    changeTheme(e.target.value);
                });
            });
        }

        function changeTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            
            // Remove all theme classes
            document.body.classList.remove('light-theme', 'midnight-theme');
            
            // Add new theme class
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else if (theme === 'midnight') {
                document.body.classList.add('midnight-theme');
            }
            
            // Update radio button borders
            document.querySelectorAll('.theme-option').forEach(option => {
                option.style.borderColor = 'transparent';
            });
            document.querySelector(`.theme-option[data-theme="${theme}"]`).style.borderColor = 'var(--primary)';
        }

        function applyTheme() {
            if (currentTheme === 'light') {
                document.body.classList.add('light-theme');
            } else if (currentTheme === 'midnight') {
                document.body.classList.add('midnight-theme');
            }
        }

        function generateStatistics() {
            // Filter out ignored courses
            const assignments = allAssignmentsData.filter(a => !ignoredCourses.has(a.courseName));
            
            // Due this week
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const thisWeek = assignments.filter(a => {
                const date = parseGoogleDate(a.dueDate);
                if (!date) return false;
                return date >= today && date <= weekFromNow && a.status !== 'submitted';
            });
            document.getElementById('upcomingWeek').textContent = thisWeek.length;

            // Total overdue
            const overdue = assignments.filter(a => a.status === 'late');
            document.getElementById('overdueTotal').textContent = overdue.length;

            // Active courses count (only courses with pending assignments)
            const pendingAssignments = assignments.filter(a => a.status !== 'submitted');
            const uniqueCourses = [...new Set(pendingAssignments.map(a => a.courseName))];
            document.getElementById('totalCourses').textContent = uniqueCourses.length;

            // Average assignments per course
            const avgPerCourse = uniqueCourses.length > 0 
                ? (pendingAssignments.length / uniqueCourses.length).toFixed(1)
                : 0;
            document.getElementById('avgPerCourse').textContent = avgPerCourse;

            // Generate charts
            generateStatusChart(assignments);
            generateCourseChart(assignments);
            generateUpcomingDeadlines(thisWeek);
        }

        function generateStatusChart(assignments) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (statusChartInstance) {
                statusChartInstance.destroy();
            }

            const pending = assignments.filter(a => a.status === 'pending').length;
            const late = assignments.filter(a => a.status === 'late').length;

            // Only show chart if there's data
            if (pending === 0 && late === 0) {
                ctx.canvas.parentElement.innerHTML = `
                    <div class="card-title">Assignment Status Distribution</div>
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <h3>No pending assignments!</h3>
                        <p>You're all caught up.</p>
                    </div>
                `;
                return;
            }

            statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Late'],
                    datasets: [{
                        data: [pending, late],
                        backgroundColor: ['#ffab00', '#fc424a'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#ffffff', padding: 15 }
                        }
                    }
                }
            });
        }

        function generateCourseChart(assignments) {
            const ctx = document.getElementById('courseChart').getContext('2d');
            
            if (courseChartInstance) {
                courseChartInstance.destroy();
            }

            // Only count pending assignments
            const pendingAssignments = assignments.filter(a => a.status !== 'submitted');

            // Count assignments by course
            const courseCounts = {};
            pendingAssignments.forEach(a => {
                courseCounts[a.courseName] = (courseCounts[a.courseName] || 0) + 1;
            });

            const courses = Object.keys(courseCounts);
            const counts = Object.values(courseCounts);

            // Only show chart if there's data
            if (courses.length === 0) {
                ctx.canvas.parentElement.innerHTML = `
                    <div class="card-title">Assignments by Course</div>
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <h3>No pending assignments!</h3>
                        <p>You're all caught up.</p>
                    </div>
                `;
                return;
            }

            courseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: courses,
                    datasets: [{
                        label: 'Assignments',
                        data: counts,
                        backgroundColor: '#b66dff',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#adb5bd',
                                stepSize: 1
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#adb5bd' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function generateUpcomingDeadlines(upcomingAssignments) {
            const container = document.getElementById('upcomingDeadlines');
            
            if (upcomingAssignments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéâ</div>
                        <div>No assignments due in the next 7 days!</div>
                    </div>
                `;
                return;
            }

            // Sort by due date
            upcomingAssignments.sort((a, b) => {
                const dateA = parseGoogleDate(a.dueDate);
                const dateB = parseGoogleDate(b.dueDate);
                return dateA - dateB;
            });

            container.innerHTML = upcomingAssignments.map(assignment => {
                const dueDate = formatDueDate(assignment);
                const statusColor = assignment.status === 'late' ? 'var(--danger)' : 'var(--warning)';
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; border-left: 3px solid ${statusColor}; margin-bottom: 0.75rem; cursor: pointer;" onclick="window.open('${assignment.link}', '_blank')">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${assignment.title}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${assignment.courseName}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: ${statusColor};">${dueDate}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${assignment.status === 'late' ? 'Overdue' : 'Upcoming'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
        }

        function showLoginScreen() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardPage').style.display = 'none';
            googleAccessToken = null;
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }

        // Event Listeners
        document.getElementById('googleLoginBtn').addEventListener('click', () => {
            if (USE_MOCK_DATA) {
                console.log('üìã Mock mode: Simulating Google login');
                googleAccessToken = 'MOCK_TOKEN';
                showDashboard();
                loadAssignments();
                return;
            }

            if (!GOOGLE_CLIENT_ID.includes('YOUR_')) {
                googleTokenClient.requestAccessToken();
            } else {
                showError('Please configure your Google Client ID first!');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            showLoginScreen();
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initializeGoogleAuth();
            updateModeIndicator();

            if (USE_MOCK_DATA) {
                console.log('%cüìã MOCK DATA MODE ENABLED', 'background: #ffab00; color: #000; font-size: 16px; padding: 8px;');
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkFlow - Assignment Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#b66dff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorkFlow">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #b66dff;
            --primary-dark: #9946e6;
            --secondary: #00d25b;
            --warning: #ffab00;
            --danger: #fc424a;
            --info: #00d0ff;
            --dark: #191c24;
            --darker: #0f1015;
            --card-bg: #1f2128;
            --border-color: #2c2e33;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --text-muted: #6c757d;
        }

        body.light-theme {
            --dark: #f5f7fa;
            --darker: #ffffff;
            --card-bg: #ffffff;
            --border-color: #e0e6ed;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --text-muted: #9ca3af;
        }

        body.midnight-theme {
            --dark: #0a0e27;
            --darker: #050816;
            --card-bg: #0f1729;
            --border-color: #1a1f3a;
            --primary: #a78bfa;
            --secondary: #34d399;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 255px;
            height: 100vh;
            background: var(--darker);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s;
        }

        .sidebar-brand {
            padding: 1.5rem 1.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-brand-icon {
            font-size: 2rem;
        }

        .sidebar-brand-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffab00;
        }

        .sidebar-menu {
            padding: 1.5rem 0;
        }

        .sidebar-menu-item {
            padding: 0.75rem 1.875rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .sidebar-menu-item:hover {
            color: var(--text-primary);
            background: rgba(182, 109, 255, 0.1);
        }

        .sidebar-menu-item.active {
            color: var(--text-primary);
            background: rgba(182, 109, 255, 0.1);
            border-left-color: var(--primary);
        }

        .sidebar-menu-icon {
            font-size: 1.2rem;
            width: 20px;
        }

        .main-panel {
            margin-left: 255px;
            min-height: 100vh;
            background: var(--dark);
            transition: all 0.3s;
        }

        .navbar {
            background: var(--card-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .navbar-left h4 {
            font-weight: 500;
            color: var(--text-primary);
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary);
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge {
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .content-wrapper {
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h3 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .breadcrumb {
            display: flex;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(182, 109, 255, 0.15);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .stat-card.primary .stat-icon {
            background: rgba(182, 109, 255, 0.2);
            color: var(--primary);
        }

        .stat-card.success .stat-icon {
            background: rgba(0, 210, 91, 0.2);
            color: var(--secondary);
        }

        .stat-card.warning .stat-icon {
            background: rgba(255, 171, 0, 0.2);
            color: var(--warning);
        }

        .stat-card.danger .stat-icon {
            background: rgba(252, 66, 74, 0.2);
            color: var(--danger);
        }

        .stat-card.info .stat-icon {
            background: rgba(0, 208, 255, 0.2);
            color: var(--info);
        }

        .assignments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .assignment-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .assignment-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(182, 109, 255, 0.2);
        }

        .assignment-badge {
            background: rgba(182, 109, 255, 0.2);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .assignment-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem;
            color: var(--text-primary);
        }

        .assignment-course {
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .assignment-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .assignment-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .assignment-status.pending {
            background: rgba(255, 171, 0, 0.2);
            color: var(--warning);
        }

        .assignment-status.late {
            background: rgba(252, 66, 74, 0.2);
            color: var(--danger);
        }

        .btn {
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e63946;
        }

        .btn-google {
            background: white;
            color: #333;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .auth-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--dark);
            padding: 2rem;
        }

        .auth-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .auth-card h2 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .notification-permission {
            background: rgba(255, 171, 0, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .time-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: rgba(182, 109, 255, 0.05);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .time-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        .time-btn.active {
            background: var(--primary);
            color: white;
        }

        .time-btn:hover:not(.active) {
            background: rgba(182, 109, 255, 0.1);
            color: var(--text-primary);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            display: flex;
            gap: 1rem;
            max-width: 80%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .chat-content {
            background: rgba(182, 109, 255, 0.1);
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .chat-message.user .chat-content {
            background: var(--primary);
            color: white;
        }

        .chat-input-container {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
        }

        .chat-input {
            flex: 1;
            background: var(--dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.875rem;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(252, 66, 74, 0.1);
            color: var(--danger);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--danger);
        }

        @media (max-width: 991px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-panel {
                margin-left: 0;
            }
            .assignments-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="auth-page" id="loginPage">
        <div class="auth-card">
            <div class="sidebar-brand-icon">üìä</div>
            <h2>WorkFlow</h2>
            <p>Track Google Classroom assignments with AI assistance & productivity insights</p>
            
            <button class="btn btn-google" id="googleLoginBtn">
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <path fill="#4285f4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
                    <path fill="#34a853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
                    <path fill="#fbbc05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
                    <path fill="#ea4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
                </svg>
                Sign in with Google Classroom
            </button>
            
            <div id="errorMsg" class="error" style="display: none; margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-brand">
                <span class="sidebar-brand-icon">üìä</span>
                <span class="sidebar-brand-text">WorkFlow</span>
            </div>
            <div class="sidebar-menu">
                <a class="sidebar-menu-item active" onclick="showPage('assignments')">
                    <span class="sidebar-menu-icon">üìù</span>
                    <span>Assignments</span>
                </a>
                <a class="sidebar-menu-item" onclick="showPage('statistics')">
                    <span class="sidebar-menu-icon">üìä</span>
                    <span>Statistics</span>
                </a>
                <a class="sidebar-menu-item" onclick="showPage('ai-assistant')">
                    <span class="sidebar-menu-icon">ü§ñ</span>
                    <span>AI Assistant</span>
                </a>
                <a class="sidebar-menu-item" onclick="showPage('courses')">
                    <span class="sidebar-menu-icon">üìö</span>
                    <span>Courses</span>
                </a>
                <a class="sidebar-menu-item" onclick="showPage('settings')">
                    <span class="sidebar-menu-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Navbar -->
            <div class="navbar">
                <div class="navbar-left">
                    <h4>Dashboard</h4>
                </div>
                <div class="navbar-right">
                    <div class="user-profile">
                        <div class="user-avatar"></div>
                        <div>
                            <div class="user-name">User</div>
                            <div class="badge">Connected</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" id="logoutBtn" style="padding: 0.5rem 1rem;">Logout</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content-wrapper">
                <!-- Assignments Page -->
                <div id="assignmentsPage">
                    <div id="notificationPermission" class="notification-permission" style="display: none;">
                        <div style="flex: 1;">
                            <strong>üì¨ Enable Notifications</strong>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.25rem 0 0;">
                                Get comedic reminders when assignments are due soon!
                            </p>
                        </div>
                        <button class="btn btn-primary" onclick="requestNotificationPermission()">Enable</button>
                    </div>

                    <div class="page-header">
                        <h3>My Assignments</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Assignments</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-info">
                                <h3 id="totalCount">0</h3>
                                <div class="stat-label">Total Assignments</div>
                            </div>
                            <div class="stat-icon">üìö</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-info">
                                <h3 id="pendingCount">0</h3>
                                <div class="stat-label">Pending</div>
                            </div>
                            <div class="stat-icon">‚è≥</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-info">
                                <h3 id="lateCount">0</h3>
                                <div class="stat-label">Late</div>
                            </div>
                            <div class="stat-icon">‚ö†Ô∏è</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-info">
                                <h3 id="dueToday">0</h3>
                                <div class="stat-label">Due Today</div>
                            </div>
                            <div class="stat-icon">üéØ</div>
                        </div>
                    </div>

                    <div id="loadingMsg" class="loading" style="display: none;">
                        Loading assignments...
                    </div>

                    <div class="assignments-grid" id="assignmentsList"></div>
                </div>

                <!-- Statistics Page -->
                <div id="statisticsPage" style="display: none;">
                    <div class="page-header">
                        <h3>Statistics & Analytics</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Statistics</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card warning">
                            <div class="stat-info">
                                <h3 id="upcomingWeek">0</h3>
                                <div class="stat-label">Due This Week</div>
                            </div>
                            <div class="stat-icon">üìÖ</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-info">
                                <h3 id="overdueTotal">0</h3>
                                <div class="stat-label">Total Overdue</div>
                            </div>
                            <div class="stat-icon">üö®</div>
                        </div>
                        <div class="stat-card primary">
                            <div class="stat-info">
                                <h3 id="totalCourses">0</h3>
                                <div class="stat-label">Active Courses</div>
                            </div>
                            <div class="stat-icon">üìö</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-info">
                                <h3 id="avgPerCourse">0</h3>
                                <div class="stat-label">Avg per Course</div>
                            </div>
                            <div class="stat-icon">üìä</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="card">
                            <div class="card-title">Assignment Status Distribution</div>
                            <canvas id="statusChart" style="max-height: 300px;"></canvas>
                        </div>

                        <div class="card">
                            <div class="card-title">Assignments by Course</div>
                            <canvas id="courseChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">üìÖ Upcoming Deadlines (Next 7 Days)</div>
                        <div id="upcomingDeadlines" style="margin-top: 1rem;"></div>
                    </div>

                    <div class="page-header" style="margin-top: 3rem;">
                        <h3>üìà Your Productivity</h3>
                        <p style="color: var(--text-secondary);">Track your assignment completion over time</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-info">
                                <h3 id="completedToday">0</h3>
                                <div class="stat-label">Completed Today</div>
                            </div>
                            <div class="stat-icon">‚úÖ</div>
                        </div>
                        <div class="stat-card primary">
                            <div class="stat-info">
                                <h3 id="currentStreak">0</h3>
                                <div class="stat-label">Day Streak</div>
                            </div>
                            <div class="stat-icon">üî•</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-info">
                                <h3 id="weeklyAvg">0</h3>
                                <div class="stat-label">Weekly Average</div>
                            </div>
                            <div class="stat-icon">üìä</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-info">
                                <h3 id="totalCompleted">0</h3>
                                <div class="stat-label">Total Completed</div>
                            </div>
                            <div class="stat-icon">üéØ</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">üìä Productivity Trends</div>
                        <div class="time-selector">
                            <button class="time-btn active" onclick="changeProductivityView('today')" data-view="today">Today</button>
                            <button class="time-btn" onclick="changeProductivityView('week')" data-view="week">7 Days</button>
                            <button class="time-btn" onclick="changeProductivityView('month')" data-view="month">30 Days</button>
                        </div>
                        <canvas id="productivityChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>

                <!-- AI Assistant Page -->
                <div id="aiAssistantPage" style="display: none;">
                    <div class="page-header">
                        <h3>ü§ñ AI Study Assistant</h3>
                        <p style="color: var(--text-secondary);">
                            Chat with AI about your assignments, get study tips, and manage your workload better!
                        </p>
                    </div>

                    <div id="apiKeyPrompt" class="card" style="display: none;">
                        <div class="card-title">üîë OpenAI API Key Required</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            To use the AI Assistant, please enter your OpenAI API key:
                        </p>
                        <div style="display: flex; gap: 1rem;">
                            <input type="password" id="apiKeyInput" placeholder="sk-proj-..." style="flex: 1; background: var(--dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-family: 'Poppins', sans-serif;">
                            <button class="btn btn-primary" onclick="saveApiKey()">Save</button>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary);">platform.openai.com/api-keys</a>
                        </p>
                    </div>

                    <div id="chatInterface" style="display: none;">
                        <div class="chat-container">
                            <div class="chat-messages" id="chatMessages">
                                <div class="chat-message">
                                    <div class="chat-avatar">ü§ñ</div>
                                    <div class="chat-content">
                                        Hi! I'm your AI study assistant. I can see you have <strong id="aiPendingCount">0</strong> pending assignments. How can I help you today?
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <textarea id="chatInput" class="chat-input" rows="2" placeholder="Ask me anything about your assignments..."></textarea>
                                <button class="btn btn-primary" onclick="sendChatMessage()" style="padding: 1rem 1.5rem;">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Courses Page -->
                <div id="coursesPage" style="display: none;">
                    <div class="page-header">
                        <h3>üìö My Courses</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Courses</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Manage Your Courses</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Uncheck courses you want to ignore. They won't appear in assignments or statistics.</p>
                        <div id="coursesList"></div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" style="display: none;">
                    <div class="page-header">
                        <h3>‚öôÔ∏è Settings</h3>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span>/</span>
                            <span>Settings</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">üé® Appearance</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Choose your preferred theme</p>
                        
                        <div style="display: grid; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" class="theme-option" data-theme="dark">
                                <input type="radio" name="theme" value="dark" style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">üåô Dark Mode</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Default dark theme with purple accents</div>
                                </div>
                            </label>

                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" class="theme-option" data-theme="midnight">
                                <input type="radio" name="theme" value="midnight" style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">üåå Midnight Mode</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Deeper blacks for OLED screens</div>
                                </div>
                            </label>

                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" class="theme-option" data-theme="light">
                                <input type="radio" name="theme" value="light" style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">‚òÄÔ∏è Light Mode</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Bright theme for daytime use</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google API & Chart.js -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
// ==========================================
// CONFIGURATION
// ==========================================
const USE_MOCK_DATA = false;
const GOOGLE_CLIENT_ID = '204169741443-lrnat59d7ob8ae63srsbg2ojefn1f51h.apps.googleusercontent.com';
const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.coursework.students.readonly https://www.googleapis.com/auth/classroom.student-submissions.students.readonly https://www.googleapis.com/auth/userinfo.profile';
const SCOPE_VERSION = 'v2.1'; // Update this to force re-login/token clear

let googleTokenClient;
let googleAccessToken = localStorage.getItem('googleAccessToken') || null;
let tokenExpiry = localStorage.getItem('tokenExpiry') || null;
let allAssignmentsData = [];
let allCoursesData = [];
let ignoredCourses = new Set(JSON.parse(localStorage.getItem('ignoredCourses') || '[]'));
let currentTheme = localStorage.getItem('theme') || 'dark';
let openaiApiKey = localStorage.getItem('openai_api_key') || null;
let previousAssignmentStates = JSON.parse(localStorage.getItem('previousStates') || '{}');
let completionHistory = JSON.parse(localStorage.getItem('completionHistory') || '{}');
let isLoading = false;
let conversationHistory = [];

let statusChartInstance = null;
let courseChartInstance = null;
let productivityChartInstance = null;
let currentProductivityView = 'week';

// ==========================================
// SERVICE WORKER & PWA INITIALIZATION
// ==========================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker registered:', registration.scope);
        setInterval(() => registration.update(), 60000);
      })
      .catch((error) => console.error('‚ùå Service Worker registration failed:', error));
  });
}

// ==========================================
// NOTIFICATION SYSTEM
// ==========================================
const COMEDIC_MESSAGES = {
  dueSoon: [
    "‚è∞ Hey procrastinator! '{title}' is due in {days} day(s). Time to panic? üôÉ",
    "üö® Assignment alert! '{title}' is coming up in {days} day(s). Netflix can wait!",
    "‚ö° Friendly reminder: '{title}' due in {days} day(s). Your future self will thank you!",
    "üéØ '{title}' needs attention in {days} day(s). Let's not make it a last-minute miracle!",
    "üìö Psst... '{title}' is due in {days} day(s). Coffee up and let's do this!",
    "üåü Don't forget! '{title}' is {days} day(s) away. You got this, champ!",
    "‚è≥ Tick tock! '{title}' is due in {days} day(s). Time to get cracking!"
  ],
  late: [
    "üò± Uh oh! '{title}' is now OVERDUE for {days} day(s). Time to channel your inner superhero! ü¶∏",
    "üî• DEFCON 1: '{title}' is late by {days} day(s)! But hey, better late than never, right?",
    "‚ö†Ô∏è Houston, we have a problem. '{title}' crossed the deadline {days} day(s) ago. Damage control time!",
    "üíÄ '{title}' has been in the danger zone for {days} day(s). Quick, before your teacher notices!",
    "üöÄ Emergency! '{title}' is {days} day(s) overdue. Activate turbo mode NOW!",
    "‚è∞ Late alert! '{title}' is {days} day(s) past due. Time for superhuman speed!",
    "üÜò '{title}' wants attention - it's been waiting {days} day(s)!"
  ]
};

async function requestNotificationPermission() {
  if (!('Notification' in window)) {
    showToast('‚ùå This browser does not support notifications');
    return;
  }

  const permission = await Notification.requestPermission();
  
  if (permission === 'granted') {
    document.getElementById('notificationPermission').style.display = 'none';
    localStorage.setItem('notificationsEnabled', 'true');
    scheduleNotificationChecks();
    showToast('üéâ Notifications enabled! You\'ll get comedic reminders for deadlines.');
  } else {
    showToast('‚ùå Notifications permission denied');
  }
}

function scheduleNotificationChecks() {
  checkAndSendNotifications();
  setInterval(checkAndSendNotifications, 60 * 60 * 1000);
}

function checkAndSendNotifications() {
  if (Notification.permission !== 'granted') return;
  
  const now = new Date();
  const filteredAssignments = allAssignmentsData.filter(a => !ignoredCourses.has(a.courseName));
  
  filteredAssignments.forEach(assignment => {
    if (!assignment.dueDate) return;
    
    const dueDate = new Date(assignment.dueDate.year, assignment.dueDate.month - 1, assignment.dueDate.day);
    const daysUntilDue = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
    
    if (daysUntilDue < 0 && assignment.status === 'late') {
      sendLateNotification(assignment, Math.abs(daysUntilDue));
    } else if (daysUntilDue >= 1 && daysUntilDue <= 3 && assignment.status === 'pending') {
      sendDueSoonNotification(assignment, daysUntilDue);
    }
  });
}

function sendDueSoonNotification(assignment, days) {
  if (!shouldShowNotification(assignment.title, 'dueSoon')) return;
  
  const messages = COMEDIC_MESSAGES.dueSoon;
  const message = messages[Math.floor(Math.random() * messages.length)]
    .replace('{title}', assignment.title)
    .replace('{days}', days);
  
  new Notification('‚è∞ Assignment Due Soon!', {
    body: message,
    icon: '/icons/icon-192x192.png',
    tag: `due-${assignment.title}`,
    requireInteraction: false
  });
  
  recordNotification(assignment.title, 'dueSoon');
}

function sendLateNotification(assignment, days) {
  if (!shouldShowNotification(assignment.title, 'late')) return;
  
  const messages = COMEDIC_MESSAGES.late;
  const message = messages[Math.floor(Math.random() * messages.length)]
    .replace('{title}', assignment.title)
    .replace('{days}', days);
  
  new Notification('üö® Assignment Overdue!', {
    body: message,
    icon: '/icons/icon-192x192.png',
    tag: `late-${assignment.title}`,
    requireInteraction: true
  });
  
  recordNotification(assignment.title, 'late');
}

function shouldShowNotification(assignmentTitle, type) {
  const key = `notif_${assignmentTitle}_${type}`;
  const lastShown = localStorage.getItem(key);
  if (!lastShown) return true;
  const hoursSinceLastShown = (Date.now() - parseInt(lastShown)) / (1000 * 60 * 60);
  return hoursSinceLastShown >= 24;
}

function recordNotification(assignmentTitle, type) {
  const key = `notif_${assignmentTitle}_${type}`;
  localStorage.setItem(key, Date.now().toString());
}

// ==========================================
// PRODUCTIVITY TRACKING
// ==========================================
function checkForCompletions(newAssignments) {
  newAssignments.forEach(assignment => {
    const key = assignment.title + '_' + assignment.courseName;
    const previousState = previousAssignmentStates[key];
    
    if (previousState && previousState !== 'submitted' && assignment.status === 'submitted') {
      trackCompletion(assignment.title);
      showToast(`üéâ Great job completing "${assignment.title}"!`);
    }
    
    previousAssignmentStates[key] = assignment.status;
  });
  
  localStorage.setItem('previousStates', JSON.stringify(previousAssignmentStates));
}

function trackCompletion(assignmentTitle, date = null) {
  const dateKey = date || new Date().toISOString().split('T')[0];
  completionHistory[dateKey] = (completionHistory[dateKey] || 0) + 1;
  localStorage.setItem('completionHistory', JSON.stringify(completionHistory));
  updateProductivityStats();
}

function updateProductivityStats() {
  const totalCompleted = Object.values(completionHistory).reduce((a, b) => a + b, 0);
  document.getElementById('totalCompleted').textContent = totalCompleted;
  
  const streak = calculateStreak();
  document.getElementById('currentStreak').textContent = streak;
  
  const weeklyAvg = calculateWeeklyAverage();
  document.getElementById('weeklyAvg').textContent = weeklyAvg.toFixed(1);
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('completedToday').textContent = completionHistory[today] || 0;
}

function calculateStreak() {
  const today = new Date();
  let streak = 0;
  
  for (let i = 0; i < 365; i++) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateKey = date.toISOString().split('T')[0];
    
    if (completionHistory[dateKey] && completionHistory[dateKey] > 0) {
      streak++;
    } else if (i > 0) {
      break;
    }
  }
  
  return streak;
}

function calculateWeeklyAverage() {
  const today = new Date();
  let totalLast7Days = 0;
  
  for (let i = 0; i < 7; i++) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateKey = date.toISOString().split('T')[0];
    totalLast7Days += completionHistory[dateKey] || 0;
  }
  
  return totalLast7Days / 7;
}

function generateProductivityChart(view = 'week') {
  const ctx = document.getElementById('productivityChart');
  if (!ctx) return;
  
  if (productivityChartInstance) {
    productivityChartInstance.destroy();
  }

  let labels = [];
  let data = [];
  const today = new Date();

  if (view === 'today') {
    // Show hourly data for today (simulated - we'll show daily as single point)
    labels = ['Today'];
    const todayKey = today.toISOString().split('T')[0];
    data = [completionHistory[todayKey] || 0];
  } else if (view === 'week') {
    // Last 7 days
    for (let i = 6; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      const dateKey = date.toISOString().split('T')[0];
      data.push(completionHistory[dateKey] || 0);
    }
  } else if (view === 'month') {
    // Last 30 days
    for (let i = 29; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      const dateKey = date.toISOString().split('T')[0];
      data.push(completionHistory[dateKey] || 0);
    }
  }

  productivityChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Assignments Completed',
        data: data,
        borderColor: '#b66dff',
        backgroundColor: 'rgba(182, 109, 255, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 5,
        pointHoverRadius: 7,
        pointBackgroundColor: '#b66dff',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(31, 33, 40, 0.95)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#b66dff',
          borderWidth: 1,
          padding: 12,
          displayColors: false,
          callbacks: {
            label: function(context) {
              return `${context.parsed.y} assignment${context.parsed.y !== 1 ? 's' : ''} completed`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            color: '#adb5bd',
            stepSize: 1,
            font: {
              family: 'Poppins'
            }
          },
          grid: { 
            color: 'rgba(255, 255, 255, 0.05)'
          }
        },
        x: {
          ticks: { 
            color: '#adb5bd',
            maxRotation: 45,
            minRotation: 45,
            font: {
              family: 'Poppins',
              size: 10
            }
          },
          grid: { 
            display: false 
          }
        }
      }
    }
  });
}

function changeProductivityView(view) {
  currentProductivityView = view;
  
  // Update button states
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.view === view) {
      btn.classList.add('active');
    }
  });
  
  generateProductivityChart(view);
}

// ==========================================
// STATISTICS CHARTS
// ==========================================
function generateStatistics() {
  const assignments = allAssignmentsData.filter(a => !ignoredCourses.has(a.courseName));
  
  // Due this week
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
  
  const thisWeek = assignments.filter(a => {
    const date = parseGoogleDate(a.dueDate);
    if (!date) return false;
    return date >= today && date <= weekFromNow && a.status !== 'submitted';
  });
  document.getElementById('upcomingWeek').textContent = thisWeek.length;

  // Total overdue
  const overdue = assignments.filter(a => a.status === 'late');
  document.getElementById('overdueTotal').textContent = overdue.length;

  // Active courses count
  const pendingAssignments = assignments.filter(a => a.status !== 'submitted');
  const uniqueCourses = [...new Set(pendingAssignments.map(a => a.courseName))];
  document.getElementById('totalCourses').textContent = uniqueCourses.length;

  // Average assignments per course
  const avgPerCourse = uniqueCourses.length > 0 
    ? (pendingAssignments.length / uniqueCourses.length).toFixed(1)
    : 0;
  document.getElementById('avgPerCourse').textContent = avgPerCourse;

  // Generate charts
  generateStatusChart(assignments);
  generateCourseChart(assignments);
  generateUpcomingDeadlines(thisWeek);
  
  // Also update productivity stats since we merged the pages
  updateProductivityStats();
  generateProductivityChart(currentProductivityView);
}

function generateStatusChart(assignments) {
  const ctx = document.getElementById('statusChart');
  if (!ctx) return;
  
  if (statusChartInstance) {
    statusChartInstance.destroy();
  }

  const pending = assignments.filter(a => a.status === 'pending').length;
  const late = assignments.filter(a => a.status === 'late').length;

  if (pending === 0 && late === 0) {
    ctx.parentElement.innerHTML = `
      <div class="card-title">Assignment Status Distribution</div>
      <div class="empty-state">
        <div class="empty-state-icon">üéâ</div>
        <h3>No pending assignments!</h3>
        <p>You're all caught up.</p>
      </div>
    `;
    return;
  }

  statusChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Pending', 'Late'],
      datasets: [{
        data: [pending, late],
        backgroundColor: ['#ffab00', '#fc424a'],
        borderWidth: 0,
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { 
            color: '#ffffff', 
            padding: 15,
            font: {
              family: 'Poppins',
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(31, 33, 40, 0.95)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#b66dff',
          borderWidth: 1,
          padding: 12
        }
      }
    }
  });
}

function generateCourseChart(assignments) {
  const ctx = document.getElementById('courseChart');
  if (!ctx) return;
  
  if (courseChartInstance) {
    courseChartInstance.destroy();
  }

  const pendingAssignments = assignments.filter(a => a.status !== 'submitted');
  const courseCounts = {};
  pendingAssignments.forEach(a => {
    courseCounts[a.courseName] = (courseCounts[a.courseName] || 0) + 1;
  });

  const courses = Object.keys(courseCounts);
  const counts = Object.values(courseCounts);

  if (courses.length === 0) {
    ctx.parentElement.innerHTML = `
      <div class="card-title">Assignments by Course</div>
      <div class="empty-state">
        <div class="empty-state-icon">üéâ</div>
        <h3>No pending assignments!</h3>
        <p>You're all caught up.</p>
      </div>
    `;
    return;
  }

  courseChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: courses,
      datasets: [{
        label: 'Assignments',
        data: counts,
        backgroundColor: '#b66dff',
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(31, 33, 40, 0.95)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#b66dff',
          borderWidth: 1,
          padding: 12
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            color: '#adb5bd',
            stepSize: 1,
            font: {
              family: 'Poppins'
            }
          },
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        x: {
          ticks: { 
            color: '#adb5bd',
            font: {
              family: 'Poppins',
              size: 10
            }
          },
          grid: { display: false }
        }
      }
    }
  });
}

function generateUpcomingDeadlines(upcomingAssignments) {
  const container = document.getElementById('upcomingDeadlines');
  if (!container) return;
  
  if (upcomingAssignments.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéâ</div>
        <div>No assignments due in the next 7 days!</div>
      </div>
    `;
    return;
  }

  upcomingAssignments.sort((a, b) => {
    const dateA = parseGoogleDate(a.dueDate);
    const dateB = parseGoogleDate(b.dueDate);
    return dateA - dateB;
  });

  container.innerHTML = upcomingAssignments.map(assignment => {
    const dueDate = formatDueDate(assignment);
    const statusColor = assignment.status === 'late' ? 'var(--danger)' : 'var(--warning)';
    
    return `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; border-left: 3px solid ${statusColor}; margin-bottom: 0.75rem; cursor: pointer;" onclick="window.open('${assignment.link}', '_blank')">
        <div style="flex: 1;">
          <div style="font-weight: 600; margin-bottom: 0.25rem;">${assignment.title}</div>
          <div style="font-size: 0.875rem; color: var(--text-secondary);">${assignment.courseName}</div>
        </div>
        <div style="text-align: right;">
          <div style="font-weight: 600; color: ${statusColor};">${dueDate}</div>
          <div style="font-size: 0.75rem; color: var(--text-muted);">${assignment.status === 'late' ? 'Overdue' : 'Upcoming'}</div>
        </div>
      </div>
    `;
  }).join('');
}

// ==========================================
// AI ASSISTANT
// ==========================================
function updateAIPendingCount() {
  const countElement = document.getElementById('aiPendingCount');
  if (!countElement) return;
  
  const filtered = allAssignmentsData.filter(a =>
    a.status !== 'submitted' && !ignoredCourses.has(a.courseName)
  );
  
  countElement.textContent = `${filtered.length} pending assignment${filtered.length !== 1 ? 's' : ''}`;
}

function initAIAssistant() {
  const chatInterface = document.getElementById('chatInterface');
  const apiKeyPrompt = document.getElementById('apiKeyPrompt');
  
  if (isLoading) {
    chatInterface.style.display = 'none';
    apiKeyPrompt.style.display = 'none';
    const container = document.getElementById('aiAssistantPage');
    let loader = document.getElementById('aiLoadingIndicator');
    if (!loader) {
      loader = document.createElement('div');
      loader.id = 'aiLoadingIndicator';
      loader.className = 'loading';
      loader.innerHTML = 'üîÆ Analyzing assignments...';
      container.appendChild(loader);
    }
    loader.style.display = 'block';
    return;
  }

  const loader = document.getElementById('aiLoadingIndicator');
  if (loader) loader.style.display = 'none';

  if (openaiApiKey) {
    apiKeyPrompt.style.display = 'none';
    chatInterface.style.display = 'block';
    updateAIPendingCount();
    
    if (!window.hasGeneratedGreeting) {
      window.hasGeneratedGreeting = true;
      generateProactiveGreeting();
    }
  } else {
    apiKeyPrompt.style.display = 'block';
    chatInterface.style.display = 'none';
  }
}

async function generateProactiveGreeting() {
  if (isLoading) return;

  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages.children.length > 0) {
    chatMessages.innerHTML = '';
  }

  const typingDiv = addTypingIndicator();

  try {
    const filtered = allAssignmentsData.filter(a =>
      a.status !== 'submitted' && !ignoredCourses.has(a.courseName)
    );

    if (filtered.length === 0) {
      typingDiv.remove();
      addChatMessage("üéâ You're all caught up! No pending assignments.", 'assistant');
      return;
    }

    const todayStr = new Date().toLocaleDateString('en-US', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    const lateCount = filtered.filter(a => a.status === 'late').length;
    const pendingCount = filtered.filter(a => a.status === 'pending').length;

    const assignmentsContext = filtered.map(a => ({
      title: a.title,
      course: a.courseName,
      description: a.description || 'No description provided',
      points: a.maxPoints || 'Ungraded',
      dueDate: a.dueDate
        ? `${a.dueDate.year}-${a.dueDate.month}-${a.dueDate.day}`
        : 'No due date',
      status: a.status
    }));

    const systemPrompt = `TODAY IS ${todayStr}
WORKLOAD: ${lateCount} late, ${pendingCount} pending.

Generate ONE sentence greeting telling the user what to focus on first.
Be urgent if something is late.

Assignments:
${JSON.stringify(assignmentsContext)}`;

    console.log('=== GREETING REQUEST ===');
    console.log('System prompt:', systemPrompt);

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${openaiApiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: "Give me a brief greeting and tell me what to focus on first." }
        ],
        max_tokens: 100
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('=== GREETING API ERROR ===');
      console.error('Status:', response.status);
      console.error('Error:', errorText);
      throw new Error("API request failed");
    }

    const data = await response.json();
    console.log('=== GREETING API RESPONSE ===');
    console.log('Full response:', data);
    
    const greeting = data.choices[0].message.content;
    console.log('Extracted greeting:', greeting);

    conversationHistory.push({ role: "assistant", content: greeting });

    typingDiv.remove();
    addChatMessage(greeting, "assistant");

  } catch (error) {
    typingDiv.remove();
    console.error("=== GREETING ERROR ===", error);

    const fallback = "Hey there! Let's take a look at what you need to work on today.";
    addChatMessage(fallback, "assistant");
    conversationHistory.push({ role: 'assistant', content: fallback });
  }
}

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  
  if (!key.startsWith('sk-')) {
    showToast('‚ùå Invalid API key format. Should start with sk-');
    return;
  }
  
  openaiApiKey = key;
  localStorage.setItem('openai_api_key', key);
  initAIAssistant();
  showToast('‚úÖ API key saved successfully!');
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  addChatMessage(message, 'user');
  input.value = '';

  const typingDiv = addTypingIndicator();

  try {
    const filtered = allAssignmentsData.filter(a =>
      a.status !== 'submitted' && !ignoredCourses.has(a.courseName)
    );

    const todayStr = new Date().toLocaleDateString('en-US', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    const lateCount = filtered.filter(a => a.status === 'late').length;
    const pendingCount = filtered.filter(a => a.status === 'pending').length;

    const assignmentsContext = filtered.map(a => ({
      title: a.title,
      course: a.courseName,
      description: a.description || 'No description provided',
      points: a.maxPoints || 'Ungraded',
      dueDate: a.dueDate ? `${a.dueDate.year}-${a.dueDate.month}-${a.dueDate.day}` : 'No due date',
      status: a.status
    }));

    const systemPrompt = `You are a smart, context-aware AI study assistant. Be concise and direct - keep responses brief when should.

TODAY: ${todayStr}
Late: ${lateCount}, Pending: ${pendingCount}

Analyze the assignments below and answer user questions accurately.
Assignments:
${JSON.stringify(assignmentsContext, null, 2)}`;

    conversationHistory.push({ role: 'user', content: message });
    
    const messages = [
      { role: 'system', content: systemPrompt },
      ...conversationHistory.slice(-10)
    ];

    console.log('=== CHAT REQUEST ===');
    console.log('User message:', message);
    console.log('Conversation history length:', conversationHistory.length);

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${openaiApiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: messages,
        max_tokens: 500
      })
    });

    if (!response.ok) {
      const errText = await response.text();
      console.error('=== CHAT API ERROR ===');
      console.error('Status:', response.status);
      console.error('Error:', errText);
      throw new Error('OpenAI API request failed');
    }

    const data = await response.json();
    console.log('=== CHAT API RESPONSE ===');
    console.log('Full response:', data);
    
    const aiMessage = data.choices[0].message.content;
    console.log('Extracted message:', aiMessage);

    conversationHistory.push({ role: 'assistant', content: aiMessage });

    typingDiv.remove();
    addChatMessage(aiMessage, 'assistant');

  } catch (error) {
    typingDiv.remove();
    console.error('=== CHAT ERROR ===', error);
    addChatMessage('‚ö†Ô∏è Sorry, I encountered an error. Please check your API key and try again.', 'assistant');
  }
}

function addChatMessage(content, sender) {
  const chatMessages = document.getElementById('chatMessages');
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${sender}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'chat-avatar';
  avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'chat-content';
  contentDiv.textContent = content;
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(contentDiv);
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
  const chatMessages = document.getElementById('chatMessages');
  
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chat-message';
  typingDiv.innerHTML = `
    <div class="chat-avatar">ü§ñ</div>
    <div class="chat-content"><span style="opacity: 0.6;">Thinking...</span></div>
  `;
  
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return typingDiv;
}

// ==========================================
// GOOGLE AUTH & ASSIGNMENTS
// ==========================================
function initializeGoogleAuth() {
  if (USE_MOCK_DATA) return;
  
  googleTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: GOOGLE_SCOPES,
    callback: handleGoogleAuthResponse,
  });
}

function handleGoogleAuthResponse(response) {
  if (response.error) {
    showError('Google authentication failed: ' + response.error);
    return;
  }
  
  googleAccessToken = response.access_token;
  const expiryTime = Date.now() + (response.expires_in || 3600) * 1000;
  localStorage.setItem('googleAccessToken', googleAccessToken);
  localStorage.setItem('tokenExpiry', expiryTime.toString());
  showDashboard();
  loadAssignments();
}

async function loadAssignments() {
  const loadingMsg = document.getElementById('loadingMsg');
  const assignmentsList = document.getElementById('assignmentsList');
  
  isLoading = true;
  loadingMsg.style.display = 'block';
  assignmentsList.innerHTML = '';
  updateAIViewIfActive();

  try {
    if (USE_MOCK_DATA) {
      document.querySelector('.user-name').textContent = 'Test Student';
      
      allCoursesData = [
        { id: '1', name: 'AP Physics' },
        { id: '2', name: 'World History' },
        { id: '3', name: 'English Lit' }
      ];

      allAssignmentsData = [
        {
          source: 'google',
          title: 'Lab Report: Kinematics',
          courseName: 'AP Physics',
          description: 'Write a full lab report on the projectile motion experiment. Include error analysis and graphs.',
          maxPoints: 100,
          dueDate: { year: 2024, month: 11, day: 20 },
          status: 'late',
          link: '#'
        },
        {
          source: 'google',
          title: 'Read Chapter 4',
          courseName: 'World History',
          description: 'Read chapter 4 and answer the review questions at the end.',
          maxPoints: 10,
          dueDate: { year: 2024, month: 11, day: 25 },
          status: 'pending',
          link: '#'
        },
        {
          source: 'google',
          title: 'Essay Draft',
          courseName: 'English Lit',
          description: 'Submit your first draft of the Macbeth analysis essay. Minimum 500 words.',
          maxPoints: 50,
          dueDate: { year: 2024, month: 11, day: 26 },
          status: 'pending',
          link: '#'
        }
      ];

      // Simulate a small delay for realism
      await new Promise(resolve => setTimeout(resolve, 800));
      
      checkForCompletions(allAssignmentsData);
      displayAssignments(allAssignmentsData);
      updateStats(allAssignmentsData);
      return;
    }

    const userinfo = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
      headers: { Authorization: `Bearer ${googleAccessToken}` }
    });

    if (userinfo.status === 401) {
      showLoginScreen();
      return;
    }

    if (userinfo.ok) {
      const pfp = await userinfo.json();
      const avatarDiv = document.querySelector('.user-avatar');
      if (pfp.picture) avatarDiv.style.backgroundImage = `url(${pfp.picture})`;
      if (pfp.name) document.querySelector('.user-name').textContent = pfp.name;
    }

    const coursesResponse = await fetch(
      'https://classroom.googleapis.com/v1/courses?studentId=me&courseStates=ACTIVE',
      { headers: { 'Authorization': `Bearer ${googleAccessToken}` }}
    );

    if (coursesResponse.status === 401) {
      showLoginScreen();
      return;
    }

    if (!coursesResponse.ok) throw new Error('Failed to fetch courses');

    const coursesData = await coursesResponse.json();
    const courses = coursesData.courses || [];
    allCoursesData = courses;
    
    const flatAssignments = [];
    
    // Process courses sequentially to avoid 429 Too Many Requests
    for (const course of courses) {
      try {
        const courseworkResponse = await fetch(
          `https://classroom.googleapis.com/v1/courses/${course.id}/courseWork`,
          { headers: { 'Authorization': `Bearer ${googleAccessToken}` }}
        );

        if (!courseworkResponse.ok) continue;

        const courseworkData = await courseworkResponse.json();
        const coursework = courseworkData.courseWork || [];
        
        // Process assignments in batches of 5 to respect rate limits
        const BATCH_SIZE = 5;
        for (let i = 0; i < coursework.length; i += BATCH_SIZE) {
          const batch = coursework.slice(i, i + BATCH_SIZE);
          const assignmentPromises = batch.map(async (work) => {
            try {
              const submissionResponse = await fetch(
                `https://classroom.googleapis.com/v1/courses/${course.id}/courseWork/${work.id}/studentSubmissions`,
                { headers: { 'Authorization': `Bearer ${googleAccessToken}` }}
              );

              if (submissionResponse.status === 403) {
                  console.warn(`‚ö†Ô∏è Access denied (403) for course ${course.name} work ${work.title}. Ensure you are enrolled as a student.`);
                  return null;
              }

              let status = 'pending';
              if (submissionResponse.ok) {
                const submissionData = await submissionResponse.json();
                const submission = submissionData.studentSubmissions?.[0];
                if (submission) {
                  status = submission.state === 'TURNED_IN' || submission.state === 'RETURNED' 
                    ? 'submitted' 
                    : submission.late ? 'late' : 'pending';
                }
              }

              return {
                source: 'google',
                title: work.title,
                courseName: course.name,
                description: work.description,
                maxPoints: work.maxPoints,
                dueDate: work.dueDate,
                dueTime: work.dueTime,
                status: status,
                link: work.alternateLink
              };
            } catch (error) {
              console.error(`Error loading submission:`, error);
              return null;
            }
          });
          
          const batchResults = await Promise.all(assignmentPromises);
          flatAssignments.push(...batchResults.filter(a => a !== null));
        }
      } catch (error) {
        console.error(`Error loading coursework for ${course.name}:`, error);
      }
    }
    
    allAssignmentsData = flatAssignments;
    
    checkForCompletions(flatAssignments);
    displayAssignments(flatAssignments);
    updateStats(flatAssignments);
    console.log('DEBUG: Courses and Coursework for current user:', {
  user: pfp.name,
  courses: courses.map(c => ({ id: c.id, name: c.name })),
  assignmentsPerCourse: await Promise.all(courses.map(async (course) => {
    const courseworkResponse = await fetch(
      `https://classroom.googleapis.com/v1/courses/${course.id}/courseWork`,
      { headers: { 'Authorization': `Bearer ${googleAccessToken}` }}
    );
    if (!courseworkResponse.ok) return { course: course.name, error: courseworkResponse.status };
    const courseworkData = await courseworkResponse.json();
    const assignments = (courseworkData.courseWork || []).map(a => ({ id: a.id, title: a.title }));
    return { course: course.name, assignments };
  }))
});

  } catch (error) {
    showError('Failed to load assignments: ' + error.message);
  } finally {
    isLoading = false;
    loadingMsg.style.display = 'none';
    updateAIViewIfActive();
  }
}

function updateAIViewIfActive() {
  const aiPage = document.getElementById('aiAssistantPage');
  if (aiPage.style.display !== 'none') {
    initAIAssistant();
  }
}

function updateStats(assignments) {
  const filteredAssignments = assignments.filter(a => !ignoredCourses.has(a.courseName));
  const pending = filteredAssignments.filter(a => a.status !== 'submitted');
  const late = filteredAssignments.filter(a => a.status === 'late');
  const dueToday = pending.filter(a => {
    const date = parseGoogleDate(a.dueDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return date && date.getTime() === today.getTime();
  });

  document.getElementById('totalCount').textContent = pending.length;
  document.getElementById('pendingCount').textContent = pending.filter(a => a.status === 'pending').length;
  document.getElementById('lateCount').textContent = late.length;
  
  updateProductivityStats();
}

function displayAssignments(assignments) {
  const assignmentsList = document.getElementById('assignmentsList');
  const filteredAssignments = assignments.filter(a => !ignoredCourses.has(a.courseName));
  const pendingAssignments = filteredAssignments.filter(a => a.status !== 'submitted');
  
  if (pendingAssignments.length === 0) {
    assignmentsList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üéâ</div>
        <h3>All caught up!</h3>
        <p>You have no pending assignments.</p>
      </div>
    `;
    return;
  }

  pendingAssignments.sort((a, b) => {
    const dateA = parseGoogleDate(a.dueDate);
    const dateB = parseGoogleDate(b.dueDate);
    if (!dateA) return 1;
    if (!dateB) return -1;
    return dateA - dateB;
  });

  assignmentsList.innerHTML = pendingAssignments.map(assignment => {
    const dueDate = formatDueDate(assignment);
    const statusClass = assignment.status;
    const statusText = assignment.status === 'late' ? 'Late' : 'Pending';
    const statusIcon = assignment.status === 'late' ? '‚ö†Ô∏è' : '‚è≥';

    return `
      <div class="assignment-card" onclick="window.open('${assignment.link}', '_blank')">
        <div class="assignment-badge">Google Classroom</div>
        <div class="assignment-title">${assignment.title}</div>
        <div class="assignment-course">${assignment.courseName}</div>
        <div class="assignment-meta">
          <span>üìÖ ${dueDate}</span>
        </div>
        <div class="assignment-status ${statusClass}">
          ${statusIcon} ${statusText}
        </div>
      </div>
    `;
  }).join('');
}

function parseGoogleDate(dueDate) {
  if (!dueDate) return null;
  return new Date(dueDate.year, dueDate.month - 1, dueDate.day);
}

function formatDueDate(assignment) {
  if (!assignment.dueDate) return 'No due date';
  
  const date = parseGoogleDate(assignment.dueDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const diffTime = date - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Due Today';
  if (diffDays === 1) return 'Due Tomorrow';
  if (diffDays < 0) return `${Math.abs(diffDays)} days overdue`;
  if (diffDays < 7) return `Due in ${diffDays} days`;
  
  return `Due ${date.toLocaleDateString()}`;
}

// ==========================================
// UI FUNCTIONS
// ==========================================
function showPage(page) {
  document.querySelectorAll('.sidebar-menu-item').forEach(item => item.classList.remove('active'));
  event.target.closest('.sidebar-menu-item').classList.add('active');

  document.getElementById('assignmentsPage').style.display = 'none';
  document.getElementById('statisticsPage').style.display = 'none';
  document.getElementById('aiAssistantPage').style.display = 'none';
  document.getElementById('coursesPage').style.display = 'none';
  document.getElementById('settingsPage').style.display = 'none';

  if (page === 'statistics') {
    document.getElementById('statisticsPage').style.display = 'block';
    generateStatistics();
  } else if (page === 'ai-assistant') {
    document.getElementById('aiAssistantPage').style.display = 'block';
    initAIAssistant();
  } else if (page === 'assignments') {
    document.getElementById('assignmentsPage').style.display = 'block';
  } else if (page === 'courses') {
    document.getElementById('coursesPage').style.display = 'block';
    displayCourses();
  } else if (page === 'settings') {
    document.getElementById('settingsPage').style.display = 'block';
    initializeSettings();
  }
}

function displayCourses() {
  const coursesList = document.getElementById('coursesList');
  
  if (allCoursesData.length === 0) {
    coursesList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìö</div><h3>No courses found</h3></div>';
    return;
  }

  const assignmentCounts = {};
  allAssignmentsData.forEach(a => {
    if (a.status !== 'submitted') {
      assignmentCounts[a.courseName] = (assignmentCounts[a.courseName] || 0) + 1;
    }
  });

  coursesList.innerHTML = allCoursesData.map(course => {
    const isIgnored = ignoredCourses.has(course.name);
    const assignmentCount = assignmentCounts[course.name] || 0;
    
    return `
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(182, 109, 255, 0.05); border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid ${isIgnored ? 'var(--text-muted)' : 'var(--primary)'};">
        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" ${isIgnored ? '' : 'checked'} onchange="toggleCourse('${course.name.replace(/'/g, "\\'")}', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
          </label>
          <div style="flex: 1; ${isIgnored ? 'opacity: 0.5;' : ''}">
            <div style="font-weight: 600; margin-bottom: 0.25rem;">${course.name}</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
              ${assignmentCount} pending assignment${assignmentCount !== 1 ? 's' : ''}
            </div>
          </div>
        </div>
        ${isIgnored ? '<span style="color: var(--text-muted); font-size: 0.875rem; font-weight: 600;">IGNORED</span>' : ''}
      </div>
    `;
  }).join('');
}

function toggleCourse(courseName, isEnabled) {
  if (isEnabled) {
    ignoredCourses.delete(courseName);
  } else {
    ignoredCourses.add(courseName);
  }
  
  localStorage.setItem('ignoredCourses', JSON.stringify([...ignoredCourses]));
  displayAssignments(allAssignmentsData);
  updateStats(allAssignmentsData);
  displayCourses();
}

function initializeSettings() {
  document.querySelectorAll('input[name="theme"]').forEach(radio => {
    if (radio.value === currentTheme) {
      radio.checked = true;
      radio.closest('.theme-option')?.style.setProperty('border-color', 'var(--primary)');
    }
  });

  document.querySelectorAll('input[name="theme"]').forEach(radio => {
    radio.addEventListener('change', (e) => changeTheme(e.target.value));
  });
}

function changeTheme(theme) {
  currentTheme = theme;
  localStorage.setItem('theme', theme);
  
  document.body.classList.remove('light-theme', 'midnight-theme');
  if (theme === 'light') document.body.classList.add('light-theme');
  else if (theme === 'midnight') document.body.classList.add('midnight-theme');
  
  document.querySelectorAll('.theme-option').forEach(option => {
    option.style.borderColor = 'transparent';
  });
  document.querySelector(`.theme-option[data-theme="${theme}"]`)?.style.setProperty('border-color', 'var(--primary)');
}

function showDashboard() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboardPage').style.display = 'block';
}

function showLoginScreen() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('dashboardPage').style.display = 'none';
  googleAccessToken = null;
  localStorage.removeItem('googleAccessToken');
  localStorage.removeItem('tokenExpiry');
}

function showError(message) {
  const errorMsg = document.getElementById('errorMsg');
  errorMsg.textContent = message;
  errorMsg.style.display = 'block';
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ==========================================
// INITIALIZATION
// ==========================================
window.addEventListener('DOMContentLoaded', () => {
  // Check scope version
  const savedScopeVersion = localStorage.getItem('scopeVersion');
  if (savedScopeVersion !== SCOPE_VERSION) {
    console.log('üßπ Scope version mismatch. Clearing tokens to force re-consent.');
    const theme = localStorage.getItem('theme'); // Preserve theme
    const ignored = localStorage.getItem('ignoredCourses'); // Preserve preferences
    localStorage.clear();
    if (theme) localStorage.setItem('theme', theme);
    if (ignored) localStorage.setItem('ignoredCourses', ignored);
    localStorage.setItem('scopeVersion', SCOPE_VERSION);
    // Reload to ensure clean state
    window.location.reload();
    return;
  }

  initializeGoogleAuth();
  
  // Apply saved theme
  if (currentTheme === 'light') {
    document.body.classList.add('light-theme');
  } else if (currentTheme === 'midnight') {
    document.body.classList.add('midnight-theme');
  }
  
  // Check notification permission
  if (localStorage.getItem('notificationsEnabled') !== 'true' && 'Notification' in window) {
    document.getElementById('notificationPermission').style.display = 'flex';
  }
  
  // Chat input enter key
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });
  }
  
  // Check for existing valid session
  if (!USE_MOCK_DATA && googleAccessToken && tokenExpiry) {
    const now = Date.now();
    const expiry = parseInt(tokenExpiry);
    
    if (now < expiry) {
      console.log('‚úÖ Restoring previous session');
      showDashboard();
      loadAssignments();
    } else {
      console.log('‚è∞ Session expired, please log in again');
      showLoginScreen();
    }
  }
  
  updateProductivityStats();
});

// Event Listeners
document.getElementById('googleLoginBtn')?.addEventListener('click', () => {
  if (USE_MOCK_DATA) {
    googleAccessToken = 'MOCK_TOKEN';
    showDashboard();
    loadAssignments();
    return;
  }

  if (GOOGLE_CLIENT_ID && !GOOGLE_CLIENT_ID.includes('YOUR_')) {
    googleTokenClient.requestAccessToken();
  } else {
    showError('Please configure your Google Client ID first!');
  }
});

document.getElementById('logoutBtn')?.addEventListener('click', showLoginScreen);
    </script>
</body>
</html